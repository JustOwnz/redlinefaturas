<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RedLine Performance – Faturação</title>
  <style>
    :root{
      --bg: #0b1020; --panel: #111827; --panel2: #0b1220; --text: #e5e7eb; --muted: #9ca3af;
      --accent: #22c55e; --accent-2:#16a34a; --danger-1:#ef4444; --danger-2:#b91c1c; --border: rgba(255,255,255,.10);
      --border-strong: rgba(255,255,255,.16); --card-grad: linear-gradient(180deg, rgba(31,41,55,.55), rgba(17,24,39,.55));
      --card-grad-strong: linear-gradient(180deg, rgba(31,41,55,.85), rgba(17,24,39,.85)); --ring: 0 0 0 3px rgba(34,197,94,.25);
      --shadow-xl: 0 20px 60px rgba(0,0,0,.45); --shadow-md: 0 10px 30px rgba(0,0,0,.35); --radius-lg: 16px; --radius-md: 12px; --speed: .18s;
    }
    *{box-sizing:border-box}
    html,body{margin:0;color:var(--text);background:radial-gradient(1200px 800px at 10% -10%, rgba(34,197,94,.10), transparent 60%),radial-gradient(800px 600px at 110% 10%, rgba(59,130,246,.10), transparent 60%),var(--bg);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;font-size:12.5px;letter-spacing:.2px;height:100dvh;display:flex;justify-content:center;padding:16px;overflow:hidden}
    .app{width:min(1260px,100%);height:calc(100dvh - 32px);background:linear-gradient(180deg,var(--panel)0%,var(--panel2)100%);border:1px solid var(--border-strong);border-radius:var(--radius-lg);display:flex;flex-direction:column;overflow:hidden;box-shadow:var(--shadow-xl);backdrop-filter:blur(6px)}
    .header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 18px;background:linear-gradient(180deg, rgba(31,41,55,.75), rgba(17,24,39,.55));border-bottom:1px solid var(--border-strong)}
    .footer{margin-top:auto;display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;border-top:1px solid var(--border-strong);background:rgba(17,24,39,.75);color:var(--muted);font-size:12px}
    .logo{width:36px;height:36px;border-radius:8px;box-shadow:0 8px 18px rgba(0,0,0,.35)}
    .columns{flex:1;display:grid;grid-template-columns:1.15fr .75fr;gap:12px;padding:12px;overflow:auto}
    @media (max-width: 980px){ .columns{ grid-template-columns:1fr } }
    .panel{background:var(--card-grad);border:1px solid var(--border-strong);border-radius:var(--radius-md);padding:10px;box-shadow:var(--shadow-md)}
    .section-title{font-weight:900;margin:0 0 8px;display:flex;align-items:center;gap:10px}
    .section-title::after{content:"";flex:1;height:1px;background:linear-gradient(90deg,rgba(255,255,255,.18),rgba(255,255,255,0))}
    .input{width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;font-size:14px;transition:border var(--speed), box-shadow var(--speed), background var(--speed)}
    .input.center{text-align:center}
    .input::placeholder{color:var(--muted)}
    .input:focus{outline:none;border-color:rgba(34,197,94,.55);box-shadow:var(--ring);background:rgba(255,255,255,.08)}
    input[readonly]{background:rgba(255,255,255,.05);color:#d1d5db}
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:9px 12px;font-weight:900;cursor:pointer;transition:transform var(--speed), filter var(--speed), background var(--speed), border-color var(--speed)}
    .btn:active{transform:translateY(1px)}
    .btn:focus-visible{outline:none;box-shadow:var(--ring)}
    .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#06140d}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-danger{background:linear-gradient(180deg,var(--danger-1),var(--danger-2));color:#fff}
    .btn-danger:hover{filter:brightness(1.05)}
    .close-btn{background:transparent;color:var(--text)}
    .warn{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.45);color:#fbbf24;padding:10px 12px;border-radius:10px;font-weight:800;display:none;margin-bottom:4px}
    details{border:1px solid var(--border);border-radius:12px;margin-bottom:10px;background:rgba(255,255,255,.03);overflow:hidden;transition:opacity var(--speed)}
    details[open] summary{border-bottom:1px solid var(--border)}
    details summary{cursor:pointer;padding:12px 14px;font-weight:900;background:rgba(255,255,255,.06)}
    details.disabled{opacity:.55;pointer-events:none}
    .mods-grid{padding:10px}
    .subcard{border:1px solid var(--border);border-radius:12px;margin-bottom:10px;background:rgba(255,255,255,.03)}
    .subcard summary{cursor:pointer;padding:12px 14px;font-weight:900}
    .subbody{padding:10px 12px}
    .list-viewport{max-height:240px;overflow:auto}
    .mod-row{display:grid;grid-template-columns:minmax(0,1fr) 120px 50px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .switch{appearance:none;width:40px;height:22px;border-radius:999px;background:#283244;position:relative;border:1px solid var(--border);cursor:pointer;transition:background var(--speed), border-color var(--speed)}
    .switch:after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#a3a9b6;transition:all var(--speed) ease;box-shadow:0 2px 8px rgba(0,0,0,.35)}
    .switch:checked{background:#19bb6e;border-color:rgba(34,197,94,.55)}
    .switch:checked:after{left:20px;background:#0b1a12}
    .svc-table{width:100%;border-collapse:separate;border-spacing:0;min-width:540px}
    .svc-table thead th{position:sticky;top:0;z-index:1;background:rgba(31,41,55,.75);backdrop-filter:blur(4px);border-bottom:1px solid var(--border-strong);padding:10px 12px;text-align:left;font-weight:900}
    .svc-table tbody td{padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.08)}
    .svc-table tbody tr:hover{background:rgba(255,255,255,.03)}
    .svc-table th:first-child,.svc-table td:first-child{padding-right:50px}
    .svc-table th:nth-child(2),.svc-table td:nth-child(2){padding-left:14px}
    .svc-table th:nth-child(3),.svc-table td:nth-child(3){width:88px;text-align:center}
    .svc-table th:nth-child(4),.svc-table td:nth-child(4){width:140px;white-space:nowrap;text-align:right}
    #totalsPanel .grid{display:grid;grid-template-columns:1fr auto;row-gap:8px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.70);z-index:50}
    .modal.open{display:flex}
    .modal-card{width:min(980px,96%);max-height:86vh;overflow:auto;background:rgba(17,24,39,.98);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:0;overflow:hidden;box-shadow:var(--shadow-xl);transform:scale(.98);opacity:0;transition:transform .18s ease,opacity .18s ease}
    .modal.open .modal-card{transform:scale(1);opacity:1}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:linear-gradient(180deg, rgba(31,41,55,.65), rgba(17,24,39,.4));border-bottom:1px solid rgba(255,255,255,.12)}
    .modal-title{font-weight:900;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
    .modal-title:before{content:"🧾";font-size:18px}
    .modal-logo{height:18px;width:auto;border-radius:4px}
    .inv-wrap{display:grid;grid-template-columns:1.2fr 360px;gap:16px;padding:16px}
    @media (max-width:980px){.inv-wrap{grid-template-columns:1fr}}
    .inv-aside-inner{position:sticky;top:16px;background:var(--card-grad-strong);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:14px;box-shadow:var(--shadow-md)}
    .inv-aside .title{font-weight:900;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .inv-aside .title::before{content:"💰"}
    .inv-total-row{display:grid;grid-template-columns:1fr auto;gap:8px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .inv-total-row:last-child{border-bottom:none}
    .inv-total-row .label{color:#9ca3af}
    .inv-final{margin-top:6px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.18);font-weight:900;font-size:18px}
    .inv-note{color:#9ca3af;font-size:12px;margin-top:8px}
    .inv-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .inv-card{background:var(--card-grad);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;display:flex;flex-direction:column;min-height:0}
    .inv-head{display:grid;grid-template-columns:160px 1fr;gap:8px}
    @media (max-width:640px){.inv-head{grid-template-columns:1fr}}
    .inv-row{display:contents}
    .inv-key{color:#9ca3af;padding:6px 0}
    .inv-val{padding:6px 0;text-align:right;font-weight:700;font-variant-numeric:tabular-nums}
    @media (max-width:640px){.inv-val{text-align:left}}
    .inv-section{margin:14px 0 6px;display:flex;align-items:center;gap:8px;font-weight:900}
    .inv-chip{font-size:12px;font-weight:800;color:#10b981;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);padding:2px 8px;border-radius:999px}
    .inv-list{border-top:1px dashed rgba(255,255,255,.08)}
    .inv-line{display:grid;grid-template-columns:1fr 130px;gap:8px;padding:8px 0;align-items:center;border-bottom:1px dashed rgba(255,255,255,.06)}
    .inv-line .name{color:#e5e7eb}
    .inv-line .price{text-align:right;font-variant-numeric:tabular-nums}
    .list-viewport,.columns,.inv-scroll{scrollbar-width:thin}
    .inv-scroll{margin-top:10px;max-height:52vh;overflow:auto;padding-right:6px}
    @media (max-height:800px){.inv-scroll{max-height:46vh}}
    @media (max-height:700px){.inv-scroll{max-height:40vh}}
    .inv-scroll::-webkit-scrollbar,.list-viewport::-webkit-scrollbar,.columns::-webkit-scrollbar{width:8px;height:8px}
    .inv-scroll::-webkit-scrollbar-thumb,.list-viewport::-webkit-scrollbar-thumb,.columns::-webkit-scrollbar-thumb{background:rgba(148,163,184,.35);border-radius:8px}
    .inv-scroll::-webkit-scrollbar-thumb:hover,.list-viewport::-webkit-scrollbar-thumb:hover,.columns::-webkit-scrollbar-thumb:hover{background:rgba(148,163,184,.55)}
    .mod-row .input,.svc-table .price-span,.svc-table .svc-total,#totalsPanel,.inv-line .price{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div style="display:flex;align-items:center;gap:14px;">
        <img class="logo" src="https://i.imgur.com/RwYDIAZ.png" alt="Logo RedLine Performance" />
        <div>
          <div style="font-weight:900;letter-spacing:.2px">RedLine Performance</div>
          <div style="font-size:12px;color:var(--muted)">Sistema de Faturas - V2</div>
        </div>
      </div>
      <span id="clock" style="font-weight:900;color:var(--muted);font-size:16px;"></span>
    </header>

    <div class="columns">
      <section>
        <details id="detailsOficina" open>
          <summary>🏠 Oficina</summary>
          <div id="modsContainer" class="mods-grid"></div>
        </details>
      </section>

      <section style="display:flex;flex-direction:column;gap:14px">
        <div id="identityWarn" class="warn">⚠️ Preencha <strong>Colaborador</strong>, <strong>Cliente</strong> e o <strong>Valor do veículo</strong> para ativar Oficina e Serviços.</div>

        <div class="panel">
          <div class="section-title">🚗 Dados</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label for="colaborador">Colaborador</label>
              <input id="colaborador" type="text" class="input center" placeholder="Nome do colaborador"/>
            </div>
            <div>
              <label for="cliente">Cliente</label>
              <input id="cliente" type="text" class="input center" placeholder="Nome do cliente"/>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:8px">
            <div>
              <label for="carValue">Valor do veículo</label>
              <input id="carValue" type="number" class="input center" placeholder="Insira o valor do carro"/>
            </div>
            <div>
              <label for="partnerPct">Parceria (%)</label>
              <input id="partnerPct" type="number" class="input center" placeholder="0"/>
            </div>
            <div>
              <label for="partnerCompany">Empresa Parceira</label>
              <input id="partnerCompany" type="text" class="input center" placeholder="Nome da empresa"/>
            </div>
          </div>
        </div>

        <div class="panel" id="servicesPanel">
          <div class="section-title">🧰 Serviços</div>
          <div style="overflow:auto">
            <table class="svc-table">
              <thead>
                <tr>
                  <th>Serviço</th>
                  <th style="text-align:right">Preço/unid</th>
                  <th style="text-align:center">Qtd</th>
                  <th style="text-align:right">Total</th>
                </tr>
              </thead>
              <tbody id="servicesBody"></tbody>
            </table>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-weight:800">
            <span style="color:var(--muted)">Subtotal serviços</span>
            <span id="svcSubtotal">0,00 €</span>
          </div>
        </div>

        <div class="panel" id="totalsPanel">
          <div class="section-title">📊 Totais</div>
          <div class="grid">
            <div style="color:var(--muted)">Oficina</div><div id="totMods">0,00 €</div>
            <div style="color:var(--muted)">Serviços</div><div id="totSvc">0,00 €</div>
            <div style="color:var(--muted)">Taxa (baixo preço)</div><div id="totSurcharge">0,00 €</div>
            <div style="color:var(--muted)">Total bruto</div><div id="totGross">0,00 €</div>
            <div style="color:var(--muted)">Desconto</div><div id="totDisc">0,00 €</div>
            <div style="font-weight:900">Total devido</div><div style="font-weight:900" id="totFinal">0,00 €</div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button id="showInvoice" class="btn btn-primary">Pré-visualizar</button>
            <button id="clearFields" class="btn btn-danger">Limpar</button>
          </div>
        </div>

      </section>
    </div>

    <footer class="footer">© 2025 RedLine Performance — Todos os direitos reservados</footer>

    <div id="invoiceModal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">
            <img class="modal-logo" src="https://i.imgur.com/RwYDIAZ.png" alt="RedLine Performance">
            Fatura detalhada
          </div>
          <button class="btn close-btn" id="closeInvoiceBtn">Fechar</button>
        </div>
        <div id="invoiceBody"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const WEBHOOK_URL = 'https://discord.com/api/webhooks/1424102295989260290/O551-zFM41O1NWTm_f7eALRbe2nqn-JUUq-0lvwY6HQwt3DfSnYc8R9WK932zf3v2ry4';
    var SERVICE_OUT_PRICE_PER_KM = 25000; // 250,00 € por km (cêntimos)
    const SERVICE_REMAP_PCT = 0.08; // 8% do valor do veículo (editável)

	// === REGRAS DE TAXA EXTRA POR FAIXA DE PREÇO DO VEÍCULO ===
	// Escala PRO (ajustada 0–20 M €)
	const SURCHARGE_RULES = [
		{ to:  50000,    pct: 0.09,  label: '0–50.000 € (9 %)' },
		{ to: 150000,    pct: 0.06,  label: '50.000–150.000 € (6 %)' },
		{ to: 500000,    pct: 0.05,  label: '150.000–500.000 € (5 %)' },
		{ to: 1000000,   pct: 0.035, label: '500.000–1.000.000 € (3,5 %)' },
		{ to: 3000000,   pct: 0.025, label: '1.000.000–3.000.000 € (2,5 %)' },
		{ to: 7000000,   pct: 0.015, label: '3.000.000–7.000.000 € (1,5 %)' },
		{ to: 20000000,  pct: 0.0075,label: '7.000.000–20.000.000 € (0,75 %)' },
		{ to: Infinity,  pct: 0,     label: '> 20.000.000 € (0 %)' }
			];

    // ====== UTIL ======
    function euro(n){ n=(isNaN(n)?0:n); var sign=n<0?'-':''; n=Math.abs(n); var euros=Math.floor(n/100); var cents=String(n%100).padStart(2,'0'); var intStr=String(euros).replace(/\B(?=(\d{3})+(?!\d))/g,'\u00A0'); return sign+intStr+','+cents+'\u00A0€'; }
    function esc(s){ const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}; return String(s??'').replace(/[&<>"']/g, m=>map[m]); }
    function onlyNum(v){ return Number(String(v||'').replace(/[^0-9-]/g,'')); }
    function gid(id){ return document.getElementById(id); }
    function gval(id){ var el=gid(id); return el?el.value:''; }
    function normalizeNumberInput(str){ return Number(String(str||'').replace(/\s|\u00A0/g,'').replace(',', '.')); }
    function clampPct(v){ v=isFinite(v)?v:0; return Math.max(0, Math.min(100, v)); }
    function debounce(fn,ms=80){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

    // Calcula a taxa extra baseada nas faixas de preço do veículo
    function getSurchargeInfo(carValEuro){
      const rule = (SURCHARGE_RULES || []).find(r => carValEuro <= r.to) || { pct:0, label:'—' };
      const amount = Math.round((carValEuro||0) * 100 * (rule.pct||0));
      return { amount, pct: rule.pct||0, label: rule.label || '' };
    }

    // ====== DADOS ======
    var OFICINA = [
      {label:'KITS ESTÉTICA', items:[
        {name:'Escape', pct:0.0152}, 
		{name:'Frame', pct:0.0152}, 
		{name:'Parachoques frontal',pct:0.0152}, 
		{name:'Grelha frontal', pct:0.0152}, 
		{name:'Capô', pct:0.0152}, 
		{name:'Guarda-lama Esquerdo', pct:0.016}, 
		{name:'Parachoques traseiro', pct:0.016}, 
		{name:'Guarda-lama dianteiro', pct:0.016}, 
		{name:'Tejadilho', pct:0.016}, 
		{name:'Saias', pct:0.0155}, 
		{name:'Spoiler', pct:0.016}
      ]},
      {label:'CORES', items:[
        {name:'Luzes frontais', pct:0.0025}, 
		{name:'Interior', pct:0.00025}, 
		{name:'Luzes neon', pct:0.0025}, 
		{name:'Perolado', pct:0.0015}, 
		{name:'Primária', pct:0.0050}, 
		{name:'Secundária', pct:0.00025}, 
		{name:'Fumo de pneus', pct:0.0015}, 
		{name:'Cor jantes', pct:0.00025}
      ]},
	  {label:'EXTRAS', items:[
		{name:'Extra', pct:0.013}
      ]},
      {label:'OUTROS', items:[
        {name:'Buzina', pct:0.00075}, 
		{name:'Estampas', pct:0.0093}, 
		{name:'Matrículas', pct:0.00080}, 
		{name:'Vidros', pct:0.0135}
      ]},
      {label:'MELHORIAS', items:[
        {name:'Blindagem N1', pct:0.057, armor:true}, 
		{name:'Blindagem N2', pct:0.077, armor:true},
		{name:'Blindagem N3', pct:0.097, armor:true}, 
		{name:'Blindagem N4', pct:0.157, armor:true}, 
		{name:'Blindagem N5', pct:0.207, armor:true}
      ]},
      {label:'JANTES', items:[{name:'Tipo de jantes', pct:0.0075}]}
    ];

    var SERVICES = [
      { name:'Kit de Reparação', price:750000 },
      { name:'CarPlay', price:5000000 },
      { name:'Tablet de Corrida', price:50000000 },
      { name:'Boosting Tablet', price:50000000 },
      { name:'GPS Hacking', price:7500000 },
      { name:'Hacking Device', price:7500000 },
      { name:'Reprogramação', percentOfCar: SERVICE_REMAP_PCT, toggleOnly:true },
      { name:'Serviço Fora (€/km)', price:SERVICE_OUT_PRICE_PER_KM }
    ];

    // ====== RUNTIME ======
    var RT = { mods:[], services:[], totals:{mods:0,svc:0,gross:0,discount:0,final:0} };

    // ====== Oficina ======
    function renderMods(){
      RT.mods = []; // idempotente
      var wrap=gid('modsContainer'); if(!wrap) return; wrap.innerHTML='';
      OFICINA.forEach(function(group){
        var det=document.createElement('details'); det.open=false; det.className='subcard'; det.innerHTML='<summary>'+group.label+'</summary>';
        var body=document.createElement('div'); body.className='subbody list-viewport';
        group.items.forEach(function(it){
          var row=document.createElement('div'); row.className='mod-row';
          row.innerHTML='<div>'+it.name+'</div>'+'<input class="input center" type="text" value="0,00\u00A0€" readonly />'+'<input type="checkbox" class="switch" role="switch" aria-checked="false"/>';
          var priceEl=row.children[1]; var toggle=row.children[2]; body.appendChild(row);
          const modRef = {group:group.label,name:it.name,pct:it.pct,armor:!!it.armor,priceEl:priceEl,toggle:toggle};
          RT.mods.push(modRef);
          toggle.addEventListener('change',function(){
            toggle.setAttribute('aria-checked', toggle.checked ? 'true' : 'false');
            if(it.armor && toggle.checked){
              RT.mods.forEach(function(m){ if(m!==modRef && m.group==='MELHORIAS' && m.armor){ m.toggle.checked=false; m.toggle.setAttribute('aria-checked','false'); m.priceEl.value=euro(0);} });
            }
            updateModPrice(modRef,priceEl,toggle);
          });
        });
        det.appendChild(body); wrap.appendChild(det);
      });
    }

    function updateModPrice(item,priceEl,toggle){
      var v=0;
      if(toggle.checked){
        var carValEuro = normalizeNumberInput(gid('carValue')?.value);
        v = Math.round(carValEuro*100*(item.pct||0));
      }
      priceEl.value=euro(v);
      recalcTotals();
    }

    // ====== Serviços ======
    function renderServices(){
      RT.services = []; // idempotente
      var body=gid('servicesBody'); if(!body) return; body.innerHTML='';
      SERVICES.forEach(function(svc){
        var tr=document.createElement('tr');
        var priceHtml = (svc.percentOfCar != null)
          ? '<span class="price-span">'+ (svc.percentOfCar*100).toFixed(2) + '% do valor</span>'
          : '<span class="price-span">'+euro(svc.price)+'</span>';
        var qtyCol = svc.toggleOnly
          ? '<input type="checkbox" class="switch svc-switch" role="switch" aria-checked="false" />'
          : '<input class="input center svc-qty" type="number" placeholder="0" min="0" style="width:72px" disabled/>';
        tr.innerHTML = '<td>'+svc.name+'</td>' +
                       '<td style="text-align:right">'+priceHtml+'</td>' +
                       '<td style="text-align:center">'+qtyCol+'</td>' +
                       '<td style="text-align:right"><span class="svc-total">0,00\u00A0€</span></td>';
        body.appendChild(tr);

        var total = tr.querySelector('.svc-total');
        var obj={name:svc.name, price:svc.price, percentOfCar:svc.percentOfCar, toggleOnly:!!svc.toggleOnly, totalEl:total};

        if(svc.toggleOnly){
          obj.switchEl = tr.querySelector('.svc-switch');
          obj.switchEl.addEventListener('change',function(){ var on=obj.switchEl && obj.switchEl.checked; obj.switchEl.setAttribute('aria-checked', on ? 'true':'false'); recalcTotals(); });
        } else {
          obj.qtyEl = tr.querySelector('.svc-qty');
          obj.qtyEl.addEventListener('input',function(){ debouncedRecalc(); });
          obj.qtyEl.disabled = true;
        }
        RT.services.push(obj);
      });
    }

    // ====== Guard / Totais ======
    function identityGuard(){
      const hasColaborador = !!(gval('colaborador')||'').trim();
      const hasCliente     = !!(gval('cliente')||'').trim();
      const carVal         = normalizeNumberInput(gval('carValue'));
      const hasCarValue    = isFinite(carVal) && carVal > 0;

      const ready = hasColaborador && hasCliente && hasCarValue;

      const warn = gid('identityWarn'); if(warn){ warn.style.display = ready ? 'none' : 'block'; }

      const dOf = gid('detailsOficina');
      if(dOf){
        // Mantém o acordeão visível; apenas aplica estilo de desativado.
        dOf.classList.toggle('disabled', !ready);
        // NÃO fecha automaticamente quando não está pronto para evitar a sensação de "sumiu".
        // Se quiseres o comportamento antigo, posso voltar a fechar/abrir aqui.
      }

      RT.mods.forEach(function(m){ m.toggle.disabled = !ready; if(!ready){ m.toggle.checked=false; m.toggle.setAttribute('aria-checked','false'); m.priceEl.value=euro(0);} });
      RT.services.forEach(function(s){ if(s.qtyEl) s.qtyEl.disabled = !ready; if(s.switchEl) s.switchEl.disabled = !ready; if(!ready){ if(s.qtyEl){ s.qtyEl.value=''; } if(s.switchEl){ s.switchEl.checked=false; s.switchEl.setAttribute('aria-checked','false'); } s.totalEl.textContent=euro(0);} });

      recalcTotals();
    }

    function recalcTotals(){
      var modsTotal = RT.mods.reduce(function(s,m){ return s+onlyNum(m.priceEl.value); },0);
      var svcTotal  = RT.services.reduce(function(sum,s){
        const carValEuro = normalizeNumberInput(gval('carValue')) || 0;
        let rowTotal = 0;
        if(s.toggleOnly){
          const on = s.switchEl && s.switchEl.checked;
          if(on){
            if(s.percentOfCar != null){
              rowTotal = Math.round(carValEuro*100*s.percentOfCar);
            } else {
              rowTotal = s.price||0;
            }
          }
        } else {
          const q = Number(s.qtyEl ? (s.qtyEl.value||0) : 0);
          if(s.percentOfCar != null){
            rowTotal = Math.max(0,q)*Math.round(carValEuro*100*s.percentOfCar);
          } else {
            rowTotal = Math.max(0,q)*(s.price||0);
          }
        }
        if(s.totalEl){ s.totalEl.textContent = euro(rowTotal); }
        return sum + rowTotal;
      },0);
      var baseGross = modsTotal + svcTotal;

      // Taxa por faixa de preço do veículo (em euros, depois convertido p/ cêntimos)
      const carValEuro = normalizeNumberInput(gval('carValue')) || 0;
      const surcharge = getSurchargeInfo(carValEuro);

      var gross = baseGross + surcharge.amount; // bruto já inclui a taxa
      var pct = clampPct(normalizeNumberInput(gval('partnerPct')||'0'));
      var discount = Math.round(gross * (pct/100));
      var final = Math.max(0, gross - discount);
      RT.totals = {mods:modsTotal, svc:svcTotal, surcharge:surcharge.amount, gross:gross, discount:discount, final:final};
      var sub = gid('svcSubtotal'); if(sub) sub.textContent = euro(svcTotal);
      if(gid('totMods')){ gid('totMods').textContent=euro(modsTotal); }
      if(gid('totSvc')){ gid('totSvc').textContent=euro(svcTotal); }
      if(gid('totSurcharge')){ gid('totSurcharge').textContent=euro(surcharge.amount); }
      if(gid('totGross')){ gid('totGross').textContent=euro(gross); }
      if(gid('totDisc')){ gid('totDisc').textContent=euro(discount); }
      if(gid('totFinal')){ gid('totFinal').textContent=euro(final); }
    }
    const debouncedRecalc = debounce(recalcTotals, 80);

    // ====== Fatura — Modal ======
    function openInvoice(){
      var col=(gval('colaborador')||'').trim(); var cli=(gval('cliente')||'').trim(); if(!col||!cli){ var w=gid('identityWarn'); if(w){ w.style.display='block'; } ( !col ? gid('colaborador') : gid('cliente') ).focus(); return; }
      var s=collectSnapshot(); var body=gid('invoiceBody'); if(!body) return;
      const kv = (k,v) => '<div class="inv-row"><div class="inv-key">'+esc(k)+'</div><div class="inv-val">'+esc(v)+'</div></div>';

      // === AGRUPAR OFICINA POR CATEGORIA NA PRÉ-VISUALIZAÇÃO ===
      let oficinaHtml = '';
      if(s.mods.lines.length){
        const byGroup = s.mods.lines.reduce((acc, m) => { (acc[m.group] ||= []).push(m); return acc; }, {});
        oficinaHtml += '<div class="inv-list">';
        Object.entries(byGroup).forEach(([grp, items]) => {
          oficinaHtml += `<div class="inv-section" style="margin-top:8px"><span>${esc(grp)}</span></div>`;
          items.forEach(m => {
            oficinaHtml += `<div class="inv-line"><div class="name">${esc(m.name)}</div><div class="price">${euro(m.total)}</div></div>`;
          });
        });
        oficinaHtml += '</div>';
      } else {
        oficinaHtml += '<div class="inv-line"><div class="name" style="color:#9ca3af">Sem extras</div><div class="price">—</div></div>';
      }

      let servicosHtml = '';
      if(s.services.lines.length){
        servicosHtml += '<div class="inv-list">';
        s.services.lines.forEach(b=>{ const q=(b.qty>1)?(' × '+b.qty):''; servicosHtml += '<div class="inv-line"><div class="name">'+esc(b.name)+q+'</div><div class="price">'+euro(b.total)+'</div></div>'; });
        servicosHtml += '</div>';
      } else {
        servicosHtml += '<div class="inv-line"><div class="name" style="color:#9ca3af">Sem serviços</div><div class="price">—</div></div>';
      }

      const aside = ['<div class="inv-aside"><div class="inv-aside-inner">','<div class="title">Totais</div>',
        '<div class="inv-total-row"><div class="label">🏠 Subtotal oficina</div><div>'+euro(s.mods.total)+'</div></div>',
        '<div class="inv-total-row"><div class="label">🧰 Subtotal serviços</div><div>'+euro(s.services.total)+'</div></div>',
        '<div class="inv-total-row"><div class="label">➕ Taxa (Baixo preço)</div><div>'+euro(s.surcharge.amount)+'</div></div>',
        '<div class="inv-total-row"><div class="label">💵 Total bruto</div><div>'+euro(s.gross)+'</div></div>',
        '<div class="inv-total-row"><div class="label">🔻 Desconto parceria</div><div>'+ (s.discount>0 ? '− ' : '') + euro(s.discount) +'</div></div>',
        '<div class="inv-final"><div style="display:flex;justify-content:space-between;gap:8px"><span>✅ Total a pagar</span><span>'+euro(s.final)+'</span></div></div>',
        '<div class="inv-note">Gerado em '+new Date(s.date).toLocaleString('pt-PT')+'</div>',
        '<div class="inv-actions"><button class="btn btn-primary" id="emitInvoiceBtn">🧾 Emitir Fatura</button></div>','</div></div>'].join('');
      const left = ['<div class="inv-card">','<div class="inv-head">',kv('Emitida em', new Date(s.date).toLocaleString('pt-PT')),kv('Colaborador', s.collaborator || '—'),kv('Cliente', s.client || '—'),kv('Parceria', (s.partnerCompany ? esc(s.partnerCompany) : '—') + ' ( '+(s.partnerPct||0)+'% )'),kv('Valor do veículo', euro(s.carVal)), '</div>','<div class="inv-scroll">','<div class="inv-section"><span>Oficina</span><span class="inv-chip">detalhe</span></div>',oficinaHtml,'<div class="inv-section" style="margin-top:14px"><span>Serviços</span><span class="inv-chip">itens</span></div>',servicosHtml,'</div>','</div>'].join('');
      body.innerHTML = '<div class="inv-wrap">'+ left + aside +'</div>'; gid('invoiceModal').classList.add('open');
      var btn=gid('emitInvoiceBtn'); if(btn){ btn.onclick=function(){ sendToWebhook(s).then(function(){ alert('Fatura enviada para o Discord.'); }).catch(function(err){ console.error(err); alert('Falha ao enviar para o Discord. Ver consola.'); }); }; }
    }

    // ====== Snapshot ======
    function collectSnapshot(){
      function txt(id){ var v=gval(id)||''; return v.trim(); }
      var carValEuro = normalizeNumberInput(gval('carValue')||0);
      var carVal = Math.round(carValEuro*100);
      var partnerPct = clampPct(normalizeNumberInput(gval('partnerPct')||'0'));
      var collaborator=txt('colaborador'); var client=txt('cliente'); var partnerCompany=txt('partnerCompany');

      // === INCLUIR CATEGORIA NAS MODS ===
      var mods=[]; RT.mods.forEach(function(m){ var v=onlyNum(m.priceEl.value); if(v>0) mods.push({group:m.group, name:m.name, total:v}); });

      var svcLines=[]; RT.services.forEach(function(s){
        if(s.toggleOnly){
          if(s.switchEl && s.switchEl.checked){
            const unit = (s.percentOfCar != null) ? Math.round(carValEuro*100*s.percentOfCar) : (s.price||0);
            svcLines.push({name:s.name, qty:1, unit:unit, total:unit});
          }
        } else {
          var q=Number(s.qtyEl ? (s.qtyEl.value||0) : 0);
          if(q>0){
            const unit = (s.percentOfCar != null) ? Math.round(carValEuro*100*s.percentOfCar) : (s.price||0);
            svcLines.push({name:s.name, qty:q, unit:unit, total:q*unit});
          }
        }
      });
      var services={lines:svcLines, total:svcLines.reduce((a,b)=>a+b.total,0)};

      var modsTotal=mods.reduce((a,b)=>a+b.total,0);
      var baseGross=services.total+modsTotal;
      var surcharge = getSurchargeInfo(carValEuro);
      var gross=baseGross + surcharge.amount; // bruto já com taxa
      var discount=Math.round(gross*(partnerPct||0)/100);
      var final=gross-discount;
      return {date:new Date().toISOString(), collaborator:collaborator, client:client, partnerCompany:partnerCompany, carVal:carVal, partnerPct:partnerPct, services:services, mods:{lines:mods,total:modsTotal}, surcharge:surcharge, gross:gross, discount:discount, final:final};
    }

    // ====== Discord ======
    function sendToWebhook(snapshot){
      return new Promise(function(resolve,reject){
        try{
          var url = WEBHOOK_URL; if(!url){ throw new Error('Webhook não configurado'); }
          const header = `🧾 Fatura • RedLine Performance • ${snapshot.collaborator || '—'}`;
          const info = [`**🗓️ Data/Hora:** ${new Date(snapshot.date).toLocaleString('pt-PT')}`,`**👤 Cliente:** ${snapshot.client || '—'}`]; if(snapshot.partnerCompany){ info.push(`**🤝 Parceria:** ${snapshot.partnerCompany} (${snapshot.partnerPct || 0}%)`);} info.push(`**🚘 Valor do veículo:** ${euro(snapshot.carVal)}`);

          // === AGRUPAR MODS POR CATEGORIA NO EMBED ===
          const modsByGroup = snapshot.mods.lines.reduce((acc, m) => { (acc[m.group] ||= []).push(m); return acc; }, {});
          const modsDesc = Object.keys(modsByGroup).length
            ? Object.entries(modsByGroup)
                .map(([grp, items]) => `**${grp}**\n` + items.map(m => `• ${m.name} — ${euro(m.total)}`).join('\n'))
                .join('\n\n')
            : '• —';

          const svcsDesc = snapshot.services.lines.length ? snapshot.services.lines.map(s => `• ${s.name}${s.qty>1?` × ${s.qty}`:''} — ${euro(s.total)}`).join('\n') : '• —';
          const totalsBlock = ['**💰 Totais**',
            `🏠 Subtotal Oficina: ${euro(snapshot.mods.total)}`,
            `🧰 Subtotal Serviços: ${euro(snapshot.services.total)}`,
            `➕ Taxa (baixo preço): ${euro(snapshot.surcharge.amount)}${snapshot.surcharge.pct ? ` (${(snapshot.surcharge.pct*100).toFixed(2)}%)` : ''}`,
            `💵 Total Bruto: ${euro(snapshot.gross)}`,
            `🔻 Desconto: ${(snapshot.discount > 0 ? '− ' : '') + euro(snapshot.discount)}`,
            `✅ Total a pagar: ${euro(snapshot.final)}`].join('\n');
          const description = [info.join('\n'),'','**🛠️ Alterações (Oficina)**',modsDesc,'','**🧰 Serviços prestados**',svcsDesc,'',totalsBlock].join('\n');
          const payload = {content:null,embeds:[{author:{name:header,icon_url:"https://i.imgur.com/RwYDIAZ.png"},description:description,color:5814783,footer:{text:new Date(snapshot.date).toLocaleString('pt-PT')}}]};
          fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(r=>{if(!r.ok) throw new Error('HTTP '+r.status); return r.text();}).then(()=>resolve()).catch(reject);
        } catch (err) { reject(err); }
      });
    }

    // ====== Limpar ======
    function clearAll(){
      ['colaborador','cliente','carValue','partnerPct','partnerCompany'].forEach(function(id){ var el=gid(id); if(el) el.value=''; });
      RT.mods.forEach(function(m){ m.toggle.checked=false; m.toggle.setAttribute('aria-checked','false'); m.priceEl.value=euro(0); });
      RT.services.forEach(function(s){ if(s.qtyEl){ s.qtyEl.value=''; s.qtyEl.disabled=true; } if(s.switchEl){ s.switchEl.checked=false; s.switchEl.setAttribute('aria-checked','false'); } s.totalEl.textContent=euro(0); });
      identityGuard(); recalcTotals();
    }

    // ====== Boot ======
    function wire(){
      window.__clockTimer = setInterval(function(){ var el=gid('clock'); if(el) el.textContent=new Date().toLocaleString('pt-PT'); },1000);
      renderMods(); renderServices();
      gid('showInvoice').addEventListener('click', openInvoice);
      gid('clearFields').addEventListener('click', clearAll);
      gid('closeInvoiceBtn').addEventListener('click', function(){ gid('invoiceModal').classList.remove('open'); });
      gid('invoiceModal').addEventListener('click', function(e){ if(e.target.id==='invoiceModal') e.currentTarget.classList.remove('open'); });
      ['colaborador','cliente'].forEach(function(id){ gid(id).addEventListener('input', identityGuard); });
      gid('carValue').addEventListener('input', function(){ identityGuard(); RT.mods.forEach(function(m){ if(m.toggle && m.toggle.checked) updateModPrice(m,m.priceEl,m.toggle); }); debouncedRecalc(); });
      gid('partnerPct').addEventListener('input', function(){ debouncedRecalc(); });
      gid('partnerPct').addEventListener('blur', function(){ const v = clampPct(normalizeNumberInput(gval('partnerPct'))); gid('partnerPct').value = String(v); recalcTotals(); });
      // Normalização do valor do carro (não permite negativos e mantém UX de placeholder)
      gid('carValue').addEventListener('blur', function(){ let v = normalizeNumberInput(gval('carValue')); v = Math.max(0, v); gid('carValue').value = v ? String(v) : ''; });
      document.addEventListener('focusin', e => { if(e.target.classList?.contains('svc-qty')) e.target.select(); });
      identityGuard();
    }
    document.addEventListener('DOMContentLoaded', wire);
    // limpar timer do relógio ao fechar
    window.addEventListener('beforeunload', function(){ if(window.__clockTimer){ clearInterval(window.__clockTimer); } }, { once:true });
    // Impedir valores negativos/decimais em Qtd (colagem, etc.)
    document.addEventListener('input', function(e){ if(e.target.classList && e.target.classList.contains('svc-qty')){ var v = Math.max(0, parseInt(e.target.value||'0',10)||0); if(String(v) !== e.target.value){ e.target.value = String(v); } } }, { passive:true });


    // ====== Atalhos de teclado ======
    document.addEventListener('keydown', function(e){
      if((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')){ e.preventDefault(); try{ openInvoice(); }catch(_){} }
      if((e.ctrlKey || e.metaKey) && (e.key === 'k' || e.key === 'K')){ e.preventDefault(); var el = gid('cliente'); if(el) el.focus(); }
    });

    // ====== SELF-TESTS ======
    document.addEventListener('DOMContentLoaded', function(){
      try{
        // € formatting
        console.assert(euro(215)==='2,15 €','euro(215) → 2,15 €');
        console.assert(euro(50000000)==='500 000,00 €','euro(50.000.000¢) → 500 000,00 €');
        console.assert(euro(300000)==='3 000,00 €','euro(300000¢) → 3 000,00 €');
        console.assert(euro(-123456)==='-1 234,56 €','euro(-123456¢) → -1 234,56 €');
        // onlyNum
        console.assert(onlyNum('7 500,00 €')===750000,'extract 7 500,00 € in cents');
        // esc
        console.assert(esc("<a 'b' & c>") === '&lt;a &#39;b&#39; &amp; c&gt;', 'esc() mapeia corretamente');
        // number normalization & clamp
        console.assert(normalizeNumberInput('10 000,50') === 10000.5, 'normaliza espaço NBSP e vírgula');
        console.assert(clampPct(150) === 100 && clampPct(-5) === 0, 'clamp 0–100');
        // surcharge tests (faixas)
        (function(){
          const sEdgeLow = getSurchargeInfo(250000); // 250k → 3%
          console.assert(sEdgeLow.amount === Math.round(250000*100*0.03), 'surcharge 250k at 3% (edge)');
          const s0 = getSurchargeInfo(200000); // 200k → 3%
          console.assert(s0.amount === Math.round(200000*100*0.03), 'surcharge 200k at 3%');
          const s1 = getSurchargeInfo(400000); // 400k → 2%
          console.assert(s1.amount === Math.round(400000*100*0.02), 'surcharge 400k at 2%');
          const sEdgeHigh = getSurchargeInfo(500000); // 500k → 2%
          console.assert(sEdgeHigh.amount === Math.round(500000*100*0.02), 'surcharge 500k at 2% (edge)');
          const s2 = getSurchargeInfo(600000); // 600k → 0%
          console.assert(s2.amount === 0, 'surcharge 600k at 0%');
        })();
        // remap tests (percentagem do carro)
        (function(){
          const car = 100000; // 100k€
          const unit = Math.round(car*100*SERVICE_REMAP_PCT);
          console.assert(unit === Math.round(100000*100*SERVICE_REMAP_PCT), 'reprogramação = pct do carro');
        })();
        // join test (evitar line breaks crús)
        (function(){
          const temp = ['a','b','c'].join('\n');
          console.assert(temp.includes('\n'), 'join com \n OK');
        })();
        // sanity timer
        console.assert(typeof window.__clockTimer !== 'undefined', 'clock timer set');
      }catch(e){ console.warn('Self-tests falharam:',e); }
    })();
  </script>
</body>
</html>
